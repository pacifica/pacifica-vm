---
dist: xenial
sudo: required
group: edge
services: docker
language: python
python: 3.8
install: pip install ansible molecule docker-py pre-commit pylint pep257 yamllint ansible-lint
script:
  - docker build -t travis_local/pacifica/pacifica-vm:latest .
  - docker run -d --name=pacifica-vm -v /sys/fs/cgroup:/sys/fs/cgroup:ro --privileged travis_local/pacifica/pacifica-vm:latest
  - docker exec pacifica-vm ansible-playbook /etc/ansible/playbook.yml
  - docker stop pacifica-vm
  - docker commit pacifica-vm pacifica/pacifica-vm:latest
deploy:
  provider: script
  script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push pacifica/pacifica-vm:latest
    - |
      if [[ $TRAVIS_TAG ]] ; then
        docker tag pacifica-vm pacifica/pacifica-vm:latest pacifica/pacifica-vm:$TRAVIS_TAG
        docker push pacifica/pacifica-vm:$TRAVIS_TAG
      fi
  on:
    branch: master
    tags: true